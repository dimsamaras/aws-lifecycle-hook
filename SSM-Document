{
  "schemaVersion": "1.2",
  "description": "Terminate runners on workers",
  "parameters": {
        "ASGNAME": {
            "type": "String",
            "description": "Auto Scaling group name"
        },
        "LIFECYCLEHOOKNAME": {
            "type": "String",
            "description": "LIFECYCLEHOOK name"
        },
        "SNSTARGET": {
            "type": "String",
            "description": "SNSTARGET"
        }
  },
  "runtimeConfig": {
    "aws:runShellScript": {
      "properties": [
        {
          "id": "0.aws:runShellScript",
          "runCommand": [
            "",
            "#!/bin/bash ",
            "INSTANCEID=$(curl http://169.254.169.254/latest/meta-data/instance-id)",
            "HOOKRESULT='CONTINUE'",
            "REGION=$(curl -s 169.254.169.254/latest/meta-data/placement/availability-zone | sed 's/.$//')",
            "",
            "sudo service sqs-runner stop &",
            "sudo service slow-runner stop &",
            "sudo service notifications-runner stop &",
            "sudo service reports-runner stop &",
            "sudo service kpis-runner stop &",
            "wait",
            "echo 'Done'",
            "MESSAGE='WORKING ON RUNNERS TERMINATION'",
            "echo $MESSAGE",
            "",
            "aws sns publish --subject 'instance terminating at {{ASGNAME}} ' --message \"$MESSAGE\"  --target-arn {{SNSTARGET}} --region ${REGION}",
            "aws autoscaling complete-lifecycle-action --lifecycle-hook-name {{LIFECYCLEHOOKNAME}} --auto-scaling-group-name {{ASGNAME}} --lifecycle-action-result ${HOOKRESULT} --instance-id ${INSTANCEID}  --region ${REGION}"
          ]
        }
      ]
    }
  }
}
